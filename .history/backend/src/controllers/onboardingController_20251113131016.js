const nodemailer = require("nodemailer");
const Onboarding = require("../models/Onboarding");

// ===============================
// ğŸ“§ Create mail transporter
// ===============================
const transporter = nodemailer.createTransport({
  host: "smtp.hostinger.com",
  port: 465,
  secure: true,
  auth: {
    user: process.env.EMAIL_USER,
    pass: process.env.EMAIL_PASS,
  },
});

// ===============================
// âœ‰ï¸ Helper to send email (Promise-based)
// ===============================
const sendEmail = (mailOptions) => {
  return new Promise((resolve, reject) => {
    transporter.sendMail(mailOptions, (err, info) => {
      if (err) return reject(err);
      resolve(info);
    });
  });
};

// ===============================
// ğŸ§© Main Controller: createOnboarding
// ===============================
const createOnboarding = async (req, res) => {
  try {
    let { companyInfo, awsSetup, agreements } = req.body;

    // âœ… Validation: ensure required fields exist
    if (!companyInfo || !awsSetup || !agreements) {
      return res.status(400).json({
        success: false,
        error: "Missing required fields",
      });
    }

    // âœ… Normalize email
    if (companyInfo.companyEmail) {
      companyInfo.companyEmail = companyInfo.companyEmail.toLowerCase().trim();
    }

    // âœ… Check for duplicate company email
    const existing = await Onboarding.findOne({
      "companyInfo.companyEmail": companyInfo.companyEmail,
    });

    if (existing) {
      return res.status(400).json({
        success: false,
        error: `Duplicate entry: The email "${companyInfo.companyEmail}" is already registered.`,
      });
    }

    // âœ… Create new onboarding record
    const newOnboarding = new Onboarding({
      companyInfo,
      awsSetup,
      agreements,
    });

    await newOnboarding.save();

    // ===============================
    // ğŸ“§ Email to User
    // ===============================
    const userMailOptions = {
      from: `"CloudSentrics" <${process.env.EMAIL_USER}>`,
      to: companyInfo.companyEmail,
      subject: "âœ… Welcome to CloudSentrics! Your Customer ID",
      html: `
        <div style="font-family: Arial, sans-serif; padding: 20px; max-width: 600px; margin: auto; color: #333;">
          <div style="text-align: center;">
            <img src="https://cloudsentrics.org/assets/logo.jpg" alt="CloudSentrics Logo" style="width: 120px; margin-bottom: 20px;" />
          </div>
          <h2 style="color: #333;">Hi ${companyInfo.primaryName || "User"},</h2>
          <p style="font-size: 16px;">
            Thank you for completing your onboarding with CloudSentrics! Weâ€™re excited to have you on board.
          </p>
          <p style="font-size: 16px;">
            Your Customer ID is: <strong>${newOnboarding.customerId}</strong>
          </p>
          <div style="margin-top: 20px; font-size: 16px;">
            <p><strong>Company Name:</strong> ${companyInfo.companyName || "N/A"}</p>
            <p><strong>Email:</strong> ${companyInfo.companyEmail}</p>
            <p><strong>Phone:</strong> ${companyInfo.companyPhone || "N/A"}</p>
            <p><strong>Country:</strong> ${companyInfo.companyCountry || "N/A"}</p>
          </div>
          <hr style="margin: 30px 0;">
          <p style="font-size: 12px; color: #999;">
            This message was auto-generated by CloudSentrics.org. Keep your Customer ID safe for future reference.
          </p>
        </div>
      `,
    };

    // ===============================
    // ğŸ“§ Email to Admin
    // ===============================
    const adminMailOptions = {
      from: `"CloudSentrics Onboarding" <${process.env.EMAIL_USER}>`,
      to: process.env.EMAIL_USER, // admin email
      subject: "ğŸ“¨ New Onboarding Submission",
      html: `
        <div style="font-family: Arial, sans-serif; padding: 20px; max-width: 600px; margin: auto; color: #333;">
          <div style="text-align: center;">
            <img src="https://cloudsentrics.org/assets/logo.jpg" alt="CloudSentrics Logo" style="width: 120px; margin-bottom: 20px;" />
          </div>
          <h2 style="color: #333;">New Onboarding Completed</h2>
          <p style="font-size: 16px;">An organization has completed onboarding:</p>
          <div style="margin-top: 20px; font-size: 16px;">
            <p><strong>ğŸ‘¤ Name:</strong> ${companyInfo.primaryName || "N/A"}</p>
            <p><strong>ğŸ¢ Company:</strong> ${companyInfo.companyName || "N/A"}</p>
            <p><strong>ğŸ“§ Email:</strong> ${companyInfo.companyEmail}</p>
            <p><strong>ğŸ“± Phone:</strong> ${companyInfo.companyPhone || "N/A"}</p>
            <p><strong>ğŸŒ Country:</strong> ${companyInfo.companyCountry || "N/A"}</p>
            <p><strong>Customer ID:</strong> ${newOnboarding.customerId}</p>
          </div>
          <hr style="margin: 30px 0;">
          <p style="font-size: 12px; color: #999;">
            This message was submitted via CloudSentrics onboarding system.
          </p>
        </div>
      `,
    };

    // âœ… Send both emails in parallel
    try {
      await Promise.all([
        sendEmail(userMailOptions),
        sendEmail(adminMailOptions),
      ]);
      console.log("âœ… Emails sent successfully to user and admin");
    } catch (emailErr) {
      console.error("âš ï¸ Failed to send email(s):", emailErr.message);
      // Donâ€™t block response
    }

    // âœ… Return success
    return res.status(201).json({
      success: true,
      message: "Onboarding saved successfully",
      customerId: newOnboarding.customerId,
    });

  } catch (err) {
    console.error("âŒ Error processing onboarding request:", err);

    // ğŸ§© Handle specific error types properly

    // âœ… Validation errors (schema-based)
    if (err.name === "ValidationError") {
      const messages = Object.values(err.errors).map(e => e.message);
      return res.status(400).json({
        success: false,
        error: `Validation failed: ${messages.join(", ")}`,
      });
    }

    // âœ… Duplicate key (MongoDB)
    if (err.code === 11000 || err?.errorResponse?.code === 11000) {
      const field = (err.keyPattern && Object.keys(err.keyPattern)[0]) ||
        (err.errorResponse?.keyPattern && Object.keys(err.errorResponse.keyPattern)[0]) ||
        "field";
      const value = (err.keyValue && Object.values(err.keyValue)[0]) ||
        (err.errorResponse?.keyValue && Object.values(err.errorResponse.keyValue)[0]) ||
        "";

      return res.status(400).json({
        success: false,
        error: `Duplicate entry: The ${field.replace("companyInfo.", "")} "${value}" is already registered.`,
      });
    }

    // âœ… Mongoose cast errors (invalid ObjectId or wrong field type)
    if (err.name === "CastError") {
      return res.status(400).json({
        success: false,
        error: `Invalid value for ${err.path}: ${err.value}`,
      });
    }

    // âœ… Email service failures
    if (err.message && err.message.includes("ENOTFOUND")) {
      return res.status(502).json({
        success: false,
        error: "Email service temporarily unavailable. Please try again later.",
      });
    }

    // âœ… Fallback for any other unexpected issue
    return res.status(500).json({
      success: false,
      error: "An unexpected error occurred while processing your request.",
    });
  }
};


// ===============================
// ğŸ§© Get company info by email
// ===============================
const getCompanyByEmail = async (req, res) => {
  try {
    const { email } = req.query;
    if (!email) {
      return res.status(400).json({ message: "Email query parameter is required" });
    }

    const company = await Onboarding.findOne({ "companyInfo.companyEmail": email.toLowerCase().trim() });

    if (!company) {
      return res.status(404).json({ message: "Company not found" });
    }

    res.json(company);
  } catch (err) {
    console.error("âŒ Error fetching company:", err);
    res.status(500).json({ message: "Server error while fetching company" });
  }
};

// ===============================
// ğŸ§© Get All Onboarded Customers
// ===============================
const getAllCustomers = async (req, res) => {
  try {
    const customers = await Onboarding.find({})
      .sort({ createdAt: -1 })
      .select(
        "customerId companyInfo awsSetup aliases agreements createdAt updatedAt"
      );

    return res.status(200).json({
      success: true,
      count: customers.length,
      customers,
    });
  } catch (error) {
    console.error("âŒ Error fetching customers:", error);
    return res.status(500).json({
      success: false,
      message: "Failed to fetch customers",
      error: error.message,
    });
  }
};

// ===============================
// ğŸ§© Get single customer by ID
// ===============================
const getCustomerById = async (req, res) => {
  try {
    const customer = await Onboarding.findById(req.params.id);

    if (!customer) {
      return res.status(404).json({
        success: false,
        message: "Customer not found",
      });
    }

    return res.status(200).json({
      success: true,
      customer,
    });
  } catch (error) {
    console.error("âŒ Error fetching customer by ID:", error);
    return res.status(500).json({
      success: false,
      message: "Failed to fetch customer",
      error: error.message,
    });
  }
};

// @desc    Delete a customer by ID
// @route   DELETE /api/admin/customers/:id
// @access  Admin
const deleteCustomer = asyncHandler(async (req, res) => {
  const { id } = req.params;

  const customer = await Onboarding.findById(id);

  if (!customer) {
    return res.status(404).json({ message: "Customer not found" });
  }

  await Onboarding.findByIdAndDelete(id);

  res.status(200).json({ message: "Customer deleted successfully" });
});



export {
  createOnboarding,
  getCompanyByEmail,
  getAllCustomers,
  getCustomerById,
  deleteCustomer,
};

